from aiogram.types import Message
from keyboards import node_keyboard
from state import get_user_state, wait_for_voice
from inventory import add_item

# =====================
# –í–°–ï –°–¶–ï–ù–´
# =====================

NODES = {
    # =====================
    # –°–¢–ê–†–¢
    # =====================
    "start": {
        "text": (
            "üåô –í–µ—á–µ—Ä –±—ã–ª —Ç—ë–ø–ª—ã–º.\n\n"
            "–¢—ã —à–ª–∞ –ø–æ –∞–ª–ª–µ–µ –ø–∞—Ä–∫–∞.\n"
            "–§–æ–Ω–∞—Ä–∏ –∑–∞–≥–æ—Ä–∞–ª–∏—Å—å –æ–¥–∏–Ω –∑–∞ –¥—Ä—É–≥–∏–º."
        ),
        "actions": {
            "üö∂‚Äç‚ôÄÔ∏è –ò–¥—Ç–∏ –¥–∞–ª—å—à–µ": "node:alley_noise"
        }
    },

    "alley_noise": {
        "text": (
            "–¢—ã —Å–¥–µ–ª–∞–ª–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤.\n\n"
            "–í–¥—Ä—É–≥ ‚Äî —Ç—Ä–µ—Å–∫ –≤–µ—Ç–æ–∫ –≤ –∫—É—Å—Ç–∞—Ö —Å–ø—Ä–∞–≤–∞."
        ),
        "actions": {
            "üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –∫—É—Å—Ç—ã": "node:bushes",
            "üö∂‚Äç‚ôÄÔ∏è –ü—Ä–æ–π—Ç–∏ –º–∏–º–æ": "node:walk_past"
        }
    },

    "bushes": {
        "text": (
            "–¢—ã —Ä–∞–∑–¥–≤–∏–≥–∞–µ—à—å –∫—É—Å—Ç—ã.\n\n"
            "–ó–∞ –Ω–∏–º–∏ –≤–∏–¥–Ω–µ–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è –±–µ—Å–µ–¥–∫–∞."
        ),
        "actions": {
            "‚û°Ô∏è –ü–æ–¥–æ–π—Ç–∏ –∫ –±–µ—Å–µ–¥–∫–µ": "node:cat_start"
        }
    },

    "walk_past": {
        "text": (
            "–¢—ã –∏–¥—ë—à—å –¥–∞–ª—å—à–µ.\n\n"
            "–ù–æ —á—É–≤—Å—Ç–≤–æ, —á—Ç–æ —Ç—ã —á—Ç–æ-—Ç–æ —É–ø—É—Å—Ç–∏–ª–∞, –Ω–µ –ø–æ–∫–∏–¥–∞–µ—Ç —Ç–µ–±—è."
        ),
        "actions": {
            "‚û°Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –±–µ—Å–µ–¥–∫–µ": "node:cat_start"
        }
    },

    # =====================
    # –ö–û–¢
    # =====================
    "cat_start": {
        "text": (
            "–í –±–µ—Å–µ–¥–∫–µ —Å–∏–¥–∏—Ç –∫–æ—Ç.\n\n"
            "–û–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ —Ç–µ–±—è —Å–ª–∏—à–∫–æ–º –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ.\n\n"
            "‚Äî –¢—ã –ø—Ä–∏—à–ª–∞ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ."
        ),
        "actions": {
            "üåô –°–ª—É—à–∞—Ç—å –∫–æ—Ç–∞": "node:cat_riddle"
        }
    },

    "cat_riddle": {
        "text": (
            "–ß—Ç–æ –Ω–µ–ª—å–∑—è —É–¥–µ—Ä–∂–∞—Ç—å —Ä—É–∫–∞–º–∏,\n"
            "–Ω–æ –º–æ–∂–Ω–æ –ø–æ–¥–∞—Ä–∏—Ç—å,\n"
            "–∏ —á–µ–º –±–æ–ª—å—à–µ –æ—Ç–¥–∞—ë—à—å ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è?"
        ),
        "actions": {
            "‚ù§Ô∏è –õ—é–±–æ–≤—å": "node:cat_hub",
            "‚è≥ –í—Ä–µ–º—è": "node:cat_wrong",
            "üí° –°–≤–µ—Ç": "node:cat_wrong"
        }
    },

    "cat_wrong": {
        "text": "‚Äî –ü–æ–¥—É–º–∞–π —Å–µ—Ä–¥—Ü–µ–º.",
        "actions": {
            "üîÅ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑": "node:cat_riddle"
        }
    },

    "cat_hub": {
        "text": "–ö–æ—Ç –¥–æ–≤–æ–ª—å–Ω–æ –º—É—Ä–ª—ã—á–µ—Ç.",
        "actions": {
            "üêæ –ü–æ–≥–ª–∞–¥–∏—Ç—å –∫–æ—Ç–∞": "cat_pet",
            "üó£ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å": "cat_talk",
            "üå≤ –£–∑–Ω–∞—Ç—å –æ –ø–∞—Ä–∫–µ": "cat_park",
            "üå∏ –ü–æ—Ö–≤–∞–ª–∏—Ç—å": "cat_praise",
            "‚û°Ô∏è –ü–æ–π—Ç–∏ –¥–∞–ª—å—à–µ": "node:fog_start"
        }
    },

    # =====================
    # –ê–ö–¢ 2 ‚Äî –¢–£–ú–ê–ù
    # =====================
    "fog_start": {
        "text": (
            "–¢—ã –æ—Ç—Ö–æ–¥–∏—à—å –æ—Ç –±–µ—Å–µ–¥–∫–∏.\n\n"
            "–¢—Ä–æ–ø–∞ —É—Ö–æ–¥–∏—Ç –≤ —Ç—É–º–∞–Ω.\n"
            "–ó–≤—É–∫–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Ç–∏—à–µ."
        ),
        "actions": {
            "üí° –°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Ñ–æ–Ω–∞—Ä–∏": "node:lanterns",
            "üí≠ –ü—Ä–∏—Å–ª—É—à–∞—Ç—å—Å—è –∫ —Å–µ–±–µ": "node:inner_voice"
        }
    },

    "lanterns": {
        "text": (
            "–§–æ–Ω–∞—Ä–∏ –º–∏–≥–∞—é—Ç.\n\n"
            "–û–¥–∏–Ω —Å–≤–µ—Ç–∏—Ç –æ—Å–æ–±–µ–Ω–Ω–æ –º—è–≥–∫–æ."
        ),
        "actions": {
            "‚ú® –ö–æ—Å–Ω—É—Ç—å—Å—è —Å–≤–µ—Ç–∞": "node:light_touch",
            "‚û°Ô∏è –ò–¥—Ç–∏ –¥–∞–ª—å—à–µ": "node:path_continue"
        }
    },

    "light_touch": {
        "text": (
            "–°–≤–µ—Ç –Ω–µ –æ–±–∂–∏–≥–∞–µ—Ç.\n\n"
            "–û–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–±—è."
        ),
        "actions": {
            "üïØ –ü—Ä–∏–Ω—è—Ç—å –¥–∞—Ä": "node:light_gift"
        }
    },

    "light_gift": {
        "text": (
            "–¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ.\n\n"
            "–≠—Ç–æ –Ω–µ –ø—Ä–µ–¥–º–µ—Ç.\n"
            "–≠—Ç–æ –æ—â—É—â–µ–Ω–∏–µ."
        ),
        "actions": {
            "‚û°Ô∏è –ò–¥—Ç–∏ –¥–∞–ª—å—à–µ": "node:path_continue"
        }
    },

    "inner_voice": {
        "text": (
            "–í —Ç–∏—à–∏–Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –º—ã—Å–ª—å:\n"
            "¬´–¢—ã –∏–¥—ë—à—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ¬ª."
        ),
        "actions": {
            "‚û°Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—É—Ç—å": "node:path_continue"
        }
    },

    "path_continue": {
        "text": (
            "–¢—Ä–æ–ø–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —É–∂–µ.\n\n"
            "–¢—ã —Å–ª—ã—à–∏—à—å –≤–æ–¥—É –≤–ø–µ—Ä–µ–¥–∏."
        ),
        "actions": {
            "üåâ –ü–æ–¥–æ–π—Ç–∏ –∫ –º–æ—Å—Ç—É": "node:bridge"
        }
    },

    # =====================
    # –ú–û–°–¢ –ò –ê–ù–ì–ï–õ
    # =====================
    "bridge": {
        "text": (
            "–¢—ã –≤—ã—Ö–æ–¥–∏—à—å –∫ —Å—Ç–∞—Ä–æ–º—É –º–æ—Å—Ç—É.\n\n"
            "–ù–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ —Å—Ç–æ–∏—Ç —Å–∏–ª—É—ç—Ç."
        ),
        "actions": {
            "üå´ –ü–æ–¥–æ–π—Ç–∏ –±–ª–∏–∂–µ": "node:angel_intro",
            "üîä –ì–æ–ª–æ—Å –ø–∞—Ä–∫–∞": "park_voice"
        }
    },

    "angel_intro": {
        "text": (
            "–ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –∞–Ω–≥–µ–ª.\n\n"
            "–ï–≥–æ –∫—Ä—ã–ª—å—è —Å–æ—Ç–∫–∞–Ω—ã –∏–∑ —Å–≤–µ—Ç–∞."
        ),
        "actions": {
            "‚ú® –°–ª—É—à–∞—Ç—å –∞–Ω–≥–µ–ª–∞": "node:angel_riddle_1"
        }
    },

    "angel_riddle_1": {
        "text": (
            "–û–Ω–∞ —Å–∏–ª—å–Ω–µ–µ –≤—Ä–µ–º–µ–Ω–∏,\n"
            "–Ω–µ –∏–º–µ–µ—Ç —Ñ–æ—Ä–º—ã,\n"
            "–Ω–æ –º–µ–Ω—è–µ—Ç —Å—É–¥—å–±—ã."
        ),
        "actions": {
            "üíû –õ—é–±–æ–≤—å": "node:angel_success",
            "üî• –°—Ç—Ä–∞—Å—Ç—å": "node:angel_wrong"
        }
    },

    "angel_wrong": {
        "text": "‚Äî –¢—ã –ø–æ—á—Ç–∏ —á—É–≤—Å—Ç–≤—É–µ—à—å.",
        "actions": {
            "üîÅ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞": "node:angel_riddle_1"
        }
    },

    "angel_success": {
        "text": (
            "–ê–Ω–≥–µ–ª —É–ª—ã–±–∞–µ—Ç—Å—è.\n\n"
            "‚Äî –¢—ã –º–æ–∂–µ—à—å –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ."
        ),
        "actions": {}
    }
}

# =====================
# –õ–û–ö–ê–õ–¨–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø
# =====================

CAT_ACTIONS = {
    "cat_pet": "–ö–æ—Ç —Ç–∏—Ö–æ –º—É—Ä–ª—ã—á–µ—Ç.",
    "cat_talk": "‚Äî –Ø –≤–∏–¥–µ–ª –º–Ω–æ–≥–∏—Ö‚Ä¶",
    "cat_park": "‚Äî –≠—Ç–æ—Ç –ø–∞—Ä–∫ –≤—ã—Ä–æ—Å –∏–∑ –æ–∂–∏–¥–∞–Ω–∏—è.",
    "cat_praise": "‚Äî –°–ª–æ–≤–∞ —Ç–æ–∂–µ –º–æ–≥—É—Ç –±—ã—Ç—å –º–∞–≥–∏–µ–π."
}

# =====================
# –û–¢–ü–†–ê–í–ö–ê –°–¶–ï–ù
# =====================

async def send_node(message: Message, node_id: str):
    user = get_user_state(message.from_user.id)

    # üé§ –∂–∏–≤–æ–π –≥–æ–ª–æ—Å –ø–∞—Ä–∫–∞
    if node_id == "park_voice":
        wait_for_voice(user, "park_voice")
        await message.answer("üå≤ –ü–∞—Ä–∫ –∑–∞—Ç–∞–∏–ª –¥—ã—Ö–∞–Ω–∏–µ‚Ä¶")
        return

    # –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    if node_id in CAT_ACTIONS:
        await message.answer(CAT_ACTIONS[node_id])
        return

    user["node"] = node_id
    node = NODES[node_id]

    if node_id == "cat_hub":
        add_item(user, "üå∏ –¶–≤–µ—Ç–æ–∫ —Ç–∏—à–∏–Ω—ã")

    await message.answer(
        node["text"],
        reply_markup=node_keyboard(node["actions"])
    )
