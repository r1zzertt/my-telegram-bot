from aiogram.types import Message
from state import get_user_state, add_item
from keyboards import node_keyboard
from nodes import NODES  # —Ç–≤–æ–π —Å–ª–æ–≤–∞—Ä—å NODES

# –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ—Ç–∞
CAT_ACTIONS = {
    "cat_pet": (
        "–ö–æ—Ç –ø—Ä–∏–∫—Ä—ã–≤–∞–µ—Ç –≥–ª–∞–∑–∞.\n\n"
        "‚Äî –ò–Ω–æ–≥–¥–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–∫–æ—Å–Ω—É—Ç—å—Å—è,\n"
        "—á—Ç–æ–±—ã –Ω–∞–ø–æ–º–Ω–∏—Ç—å —Å–µ–±–µ,\n"
        "—á—Ç–æ —Ç—ã –∂–∏–≤–∞—è."
    ),
    "cat_park": (
        "‚Äî –≠—Ç–æ—Ç –ø–∞—Ä–∫ –ø–æ–º–Ω–∏—Ç –±–æ–ª—å—à–µ,\n"
        "—á–µ–º –∫–∞–∂–µ—Ç—Å—è, ‚Äî –≥–æ–≤–æ—Ä–∏—Ç –∫–æ—Ç.\n\n"
        "‚Äî –û–Ω —Å–ª—ã—à–∞–ª —à–∞–≥–∏ —Ç–µ—Ö,\n"
        "–∫—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏–ª —Å—é–¥–∞ —É–±–µ–≥–∞—Ç—å.\n"
        "–ò —Ç–µ—Ö,\n"
        "–∫—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏–ª –∏—Å–∫–∞—Ç—å."
    ),
    "cat_path": (
        "–ö–æ—Ç —á—É—Ç—å —É–ª—ã–±–∞–µ—Ç—Å—è.\n\n"
        "‚Äî –ü—É—Ç—å –Ω–µ –≤—Å–µ–≥–¥–∞ –≤–µ–¥—ë—Ç –≤–ø–µ—Ä—ë–¥.\n"
        "–ò–Ω–æ–≥–¥–∞ –æ–Ω –ø—Ä–æ—Å—Ç–æ\n"
        "–ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è.\n\n"
        "‚Äî –¢—ã —É–∂–µ –Ω–∞ –Ω—ë–º."
    )
}

# –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–µ—Ä–µ–≤–∞
TREE_ACTIONS = {
    "tree_love": (
        "–î–µ—Ä–µ–≤–æ —à—É–º–∏—Ç –ª–∏—Å—Ç–≤–æ–π.\n\n"
        "‚Äî –õ—é–±–æ–≤—å –Ω–µ –≤—Å–µ–≥–¥–∞ —Ç—ë–ø–ª–∞—è.\n"
        "–ò–Ω–æ–≥–¥–∞ –æ–Ω–∞ ‚Äî –≤—ã–±–æ—Ä.\n"
        "–ò–Ω–æ–≥–¥–∞ ‚Äî —Ç–µ—Ä–ø–µ–Ω–∏–µ.\n\n"
        "‚Äî –ê –∏–Ω–æ–≥–¥–∞\n"
        "–æ–Ω–∞ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞—ë—Ç—Å—è."
    ),
    "tree_fear": (
        "‚Äî –ü–æ—Ç–µ—Ä–∏ –±–æ—è—Ç—Å—è —Ç–µ,\n"
        "–∫—Ç–æ —É–∂–µ —É–º–µ–µ—Ç —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å,\n"
        "‚Äî –≥–æ–≤–æ—Ä–∏—Ç –¥–µ—Ä–µ–≤–æ.\n\n"
        "‚Äî –≠—Ç–æ –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å.\n"
        "–≠—Ç–æ —Ü–µ–Ω–∞."
    ),
    "tree_desire": (
        "–î–µ—Ä–µ–≤–æ –Ω–∞–∫–ª–æ–Ω—è–µ—Ç –≤–µ—Ç–≤–∏ –Ω–∏–∂–µ.\n\n"
        "‚Äî –ù–∞—Å—Ç–æ—è—â–∏–µ –∂–µ–ª–∞–Ω–∏—è\n"
        "–≤—Å–µ–≥–¥–∞ —Ç–∏—à–µ,\n"
        "—á–µ–º –æ–∂–∏–¥–∞–Ω–∏—è –¥—Ä—É–≥–∏—Ö."
    )
}

async def send_node(message: Message, node_id: str):
    user = get_user_state(message.from_user.id)

    # --- –¥–µ–π—Å—Ç–≤–∏—è –∫–æ—Ç–∞ ---
    if node_id in CAT_ACTIONS:
        await message.answer(CAT_ACTIONS[node_id])
        user["node"] = "cat_hub"
        await message.answer(
            "–í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –µ—â—ë —á—Ç–æ-—Ç–æ:",
            reply_markup=node_keyboard(NODES["cat_hub"]["actions"])
        )
        return

    # --- –¥–µ–π—Å—Ç–≤–∏—è –¥–µ—Ä–µ–≤–∞ ---
    if node_id in TREE_ACTIONS:
        await message.answer(TREE_ACTIONS[node_id])
        # –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥–µ—Ä–µ–≤–µ
        user["node"] = "tree_question_1"
        await message.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –¥–µ—Ä–µ–≤–∞:",
            reply_markup=node_keyboard(NODES["tree_question_1"]["actions"])
        )
        return

    # --- –∑–∞—â–∏—Ç–∞: —É–∑–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω ---
    node = NODES.get(node_id)
    if not node:
        await message.answer("–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫‚Ä¶ üå´")
        return

    # --- —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π —É–∑–µ–ª ---
    user["node"] = node_id

    # --- –ø—Ä–µ–¥–º–µ—Ç—ã ---
    if node_id == "cat_hub":
        add_item(user, "üå∏ –¶–≤–µ—Ç–æ–∫ —Ç–∏—à–∏–Ω—ã")
    if node_id == "puppy_take":
        add_item(user, "üê∂ –©–µ–Ω–æ–∫")

    # --- –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∏ –∫–Ω–æ–ø–æ–∫ ---
    await message.answer(
        node["text"],
        reply_markup=node_keyboard(node.get("actions", {}))
    )
