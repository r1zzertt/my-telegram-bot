from aiogram.types import Message
from keyboards import node_keyboard
from state import get_user_state, wait_for_voice
from inventory import add_item

# =====================
# –í–°–ï –°–¶–ï–ù–´
# =====================

NODES = {
    "start": {
        "text": (
            "üåô –í–µ—á–µ—Ä –±—ã–ª —Ç—ë–ø–ª—ã–º.\n\n"
            "–¢—ã —à–ª–∞ –ø–æ –∞–ª–ª–µ–µ –ø–∞—Ä–∫–∞.\n"
            "–§–æ–Ω–∞—Ä–∏ –∑–∞–≥–æ—Ä–∞–ª–∏—Å—å –æ–¥–∏–Ω –∑–∞ –¥—Ä—É–≥–∏–º."
        ),
        "actions": {
            "üö∂‚Äç‚ôÄÔ∏è –ò–¥—Ç–∏ –¥–∞–ª—å—à–µ": "node:alley_noise"
        }
    },

    "alley_noise": {
        "text": (
            "–¢—ã —Å–¥–µ–ª–∞–ª–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤.\n\n"
            "–í–¥—Ä—É–≥ ‚Äî —Ç—Ä–µ—Å–∫ –≤–µ—Ç–æ–∫ –≤ –∫—É—Å—Ç–∞—Ö —Å–ø—Ä–∞–≤–∞."
        ),
        "actions": {
            "üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –∫—É—Å—Ç—ã": "node:bushes",
            "üö∂‚Äç‚ôÄÔ∏è –ü—Ä–æ–π—Ç–∏ –º–∏–º–æ": "node:walk_past"
        }
    },

    "bushes": {
        "text": (
            "–¢—ã —Ä–∞–∑–¥–≤–∏–≥–∞–µ—à—å –∫—É—Å—Ç—ã.\n\n"
            "–ó–∞ –Ω–∏–º–∏ –≤–∏–¥–Ω–µ–µ—Ç—Å—è —Å—Ç–∞—Ä–∞—è –±–µ—Å–µ–¥–∫–∞."
        ),
        "actions": {
            "‚û°Ô∏è –ü–æ–¥–æ–π—Ç–∏ –∫ –±–µ—Å–µ–¥–∫–µ": "node:cat_start"
        }
    },

    "walk_past": {
        "text": (
            "–¢—ã –∏–¥—ë—à—å –¥–∞–ª—å—à–µ.\n\n"
            "–ù–æ —á—É–≤—Å—Ç–≤–æ, —á—Ç–æ —Ç—ã —á—Ç–æ-—Ç–æ —É–ø—É—Å—Ç–∏–ª–∞, –Ω–µ –ø–æ–∫–∏–¥–∞–µ—Ç —Ç–µ–±—è."
        ),
        "actions": {
            "‚û°Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –±–µ—Å–µ–¥–∫–µ": "node:cat_start"
        }
    },

    # =====================
    # –ö–û–¢
    # =====================

    "cat_start": {
        "text": (
            "–í –±–µ—Å–µ–¥–∫–µ —Å–∏–¥–∏—Ç –∫–æ—Ç.\n\n"
            "–û–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ —Ç–µ–±—è —Å–ª–∏—à–∫–æ–º –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ.\n\n"
            "‚Äî –¢—ã –ø—Ä–∏—à–ª–∞ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ, ‚Äî –≥–æ–≤–æ—Ä–∏—Ç –æ–Ω."
        ),
        "actions": {
            "üåô –°–ª—É—à–∞—Ç—å –∫–æ—Ç–∞": "node:cat_riddle"
        }
    },

    "cat_riddle": {
        "text": (
            "‚Äî –û—Ç–≤–µ—Ç—å –º–Ω–µ, ‚Äî –≥–æ–≤–æ—Ä–∏—Ç –∫–æ—Ç.\n\n"
            "–ß—Ç–æ –Ω–µ–ª—å–∑—è —É–¥–µ—Ä–∂–∞—Ç—å —Ä—É–∫–∞–º–∏,\n"
            "–Ω–æ –º–æ–∂–Ω–æ –ø–æ–¥–∞—Ä–∏—Ç—å,\n"
            "–∏ —á–µ–º –±–æ–ª—å—à–µ –æ—Ç–¥–∞—ë—à—å ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è?"
        ),
        "actions": {
            "‚ù§Ô∏è –õ—é–±–æ–≤—å": "node:cat_hub",
            "‚è≥ –í—Ä–µ–º—è": "node:cat_wrong",
            "üí° –°–≤–µ—Ç": "node:cat_wrong"
        }
    },

    "cat_wrong": {
        "text": (
            "–ö–æ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ –∫–∞—á–∞–µ—Ç –≥–æ–ª–æ–≤–æ–π.\n\n"
            "‚Äî –ü–æ–¥—É–º–∞–π —Å–µ—Ä–¥—Ü–µ–º."
        ),
        "actions": {
            "üîÅ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â—ë —Ä–∞–∑": "node:cat_riddle"
        }
    },

    "cat_hub": {
        "text": (
            "–ö–æ—Ç –¥–æ–≤–æ–ª—å–Ω–æ –º—É—Ä–ª—ã—á–µ—Ç.\n\n"
            "‚Äî –¢—ã —á—É–≤—Å—Ç–≤—É–µ—à—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ.\n\n"
            "–û–Ω –æ—Å—Ç–∞—ë—Ç—Å—è —Ä—è–¥–æ–º, –±—É–¥—Ç–æ –Ω–∏–∫—É–¥–∞ –Ω–µ —Ç–æ—Ä–æ–ø–∏—Ç—Å—è."
        ),
        "actions": {
            "üêæ –ü–æ–≥–ª–∞–¥–∏—Ç—å –∫–æ—Ç–∞": "cat_pet",
            "üó£ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –∫–æ—Ç–æ–º": "cat_talk",
            "üå≤ –£–∑–Ω–∞—Ç—å –æ –ø–∞—Ä–∫–µ": "cat_park",
            "üå∏ –ü–æ—Ö–≤–∞–ª–∏—Ç—å –∫–æ—Ç–∞": "cat_praise",
            "‚û°Ô∏è –ü–æ–π—Ç–∏ –¥–∞–ª—å—à–µ": "node:after_cat"
        }
    },

    "after_cat": {
        "text": (
            "–¢—ã –ø—Ä–æ—â–∞–µ—à—å—Å—è —Å –∫–æ—Ç–æ–º.\n\n"
            "–û–Ω —Å–º–æ—Ç—Ä–∏—Ç —Ç–µ–±–µ –≤—Å–ª–µ–¥.\n\n"
            "–¢—ã –≤—ã—Ö–æ–¥–∏—à—å –Ω–∞ —Ç—Ä–æ–ø–∏–Ω–∫—É –∫ –º–æ—Å—Ç—É."
        ),
        "actions": {
            "üåâ –ü–æ–¥–æ–π—Ç–∏ –∫ –º–æ—Å—Ç—É": "node:bridge"
        }
    },

    # =====================
    # –ú–û–°–¢ –ò –ê–ù–ì–ï–õ
    # =====================

    "bridge": {
        "text": (
            "–¢—ã –≤—ã—Ö–æ–¥–∏—à—å –∫ —Å—Ç–∞—Ä–æ–º—É –º–æ—Å—Ç—É.\n\n"
            "–í–æ–¥–∞ –ø–æ–¥ –Ω–∏–º —Å–≤–µ—Ç–∏—Ç—Å—è –º—è–≥–∫–∏–º —Å–≤–µ—Ç–æ–º.\n\n"
            "–ù–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ –º–æ—Å—Ç–∞ —Å—Ç–æ–∏—Ç —Å–∏–ª—É—ç—Ç."
        ),
        "actions": {
            "üå´ –ü–æ–¥–æ–π—Ç–∏ –±–ª–∏–∂–µ": "node:angel_intro",
            "üîä –ì–æ–ª–æ—Å –ø–∞—Ä–∫–∞": "park_voice"
        }
    },

    "angel_intro": {
        "text": (
            "–ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –∞–Ω–≥–µ–ª.\n\n"
            "–ï–≥–æ –∫—Ä—ã–ª—å—è —Å–ª–æ–≤–Ω–æ —Å–æ—Ç–∫–∞–Ω—ã –∏–∑ —Å–≤–µ—Ç–∞.\n\n"
            "‚Äî –Ø —Ö—Ä–∞–Ω—é –ø—É—Ç—å –¥–∞–ª—å—à–µ."
        ),
        "actions": {
            "‚ú® –°–ª—É—à–∞—Ç—å –∞–Ω–≥–µ–ª–∞": "node:angel_riddle_1"
        }
    },

    "angel_riddle_1": {
        "text": (
            "‚Äî –ü–µ—Ä–≤–∞—è –∏—Å—Ç–∏–Ω–∞:\n\n"
            "–û–Ω–∞ —Å–∏–ª—å–Ω–µ–µ –≤—Ä–µ–º–µ–Ω–∏,\n"
            "–Ω–µ –∏–º–µ–µ—Ç —Ñ–æ—Ä–º—ã,\n"
            "–Ω–æ –º–µ–Ω—è–µ—Ç —Å—É–¥—å–±—ã."
        ),
        "actions": {
            "üíû –õ—é–±–æ–≤—å": "node:angel_success",
            "üî• –°—Ç—Ä–∞—Å—Ç—å": "node:angel_wrong",
            "üåô –°—É–¥—å–±–∞": "node:angel_wrong"
        }
    },

    "angel_wrong": {
        "text": (
            "–ê–Ω–≥–µ–ª –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≥–ª–∞–∑–∞.\n\n"
            "‚Äî –¢—ã –ø–æ—á—Ç–∏ —á—É–≤—Å—Ç–≤—É–µ—à—å."
        ),
        "actions": {
            "üîÅ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞": "node:angel_riddle_1"
        }
    },

    "angel_success": {
        "text": (
            "–ê–Ω–≥–µ–ª —É–ª—ã–±–∞–µ—Ç—Å—è.\n\n"
            "‚Äî –¢—ã –º–æ–∂–µ—à—å –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ."
        ),
        "actions": {}
    }
}

# =====================
# –î–ï–ô–°–¢–í–ò–Ø –ö–û–¢–ê (–ù–ï –ú–ï–ù–Ø–Æ–¢ –°–¶–ï–ù–£)
# =====================

CAT_ACTIONS = {
    "cat_pet": (
        "–¢—ã –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ –≥–ª–∞–¥–∏—à—å –∫–æ—Ç–∞.\n\n"
        "–û–Ω —Ç–∏—Ö–æ –º—É—Ä–ª—ã—á–µ—Ç.\n"
        "‚Äî –ù–µ –≤—Å–µ —Ä–µ—à–∞—é—Ç—Å—è –Ω–∞ —ç—Ç–æ—Ç –∂–µ—Å—Ç."
    ),
    "cat_talk": (
        "‚Äî –Ø –≤–∏–¥–µ–ª –º–Ω–æ–≥–∏—Ö, ‚Äî –≥–æ–≤–æ—Ä–∏—Ç –∫–æ—Ç.\n"
        "‚Äî –ù–æ –Ω–µ –≤—Å–µ –¥–æ—Ö–æ–¥–∏–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞."
    ),
    "cat_park": (
        "‚Äî –≠—Ç–æ—Ç –ø–∞—Ä–∫ –≤—ã—Ä–æ—Å –∏–∑ –æ–∂–∏–¥–∞–Ω–∏—è,\n"
        "‚Äî –∏–∑ –Ω–∞–¥–µ–∂–¥—ã –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å —Ç–æ–≥–æ, –∫—Ç–æ –≤–∞–∂–µ–Ω."
    ),
    "cat_praise": (
        "–ö–æ—Ç –æ—Ç–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è.\n"
        "‚Äî –°–ª–æ–≤–∞ —Ç–æ–∂–µ –º–æ–≥—É—Ç –±—ã—Ç—å –º–∞–≥–∏–µ–π."
    )
}

# =====================
# –û–¢–ü–†–ê–í–ö–ê –°–¶–ï–ù
# =====================

async def send_node(message: Message, node_id: str):
    user = get_user_state(message.from_user.id)

    # üé§ –ñ–∏–≤–æ–π –≥–æ–ª–æ—Å –ø–∞—Ä–∫–∞
    if node_id == "park_voice":
        wait_for_voice(user, "park_voice")
        await message.answer("üå≤ –ü–∞—Ä–∫ –∑–∞—Ç–∞–∏–ª –¥—ã—Ö–∞–Ω–∏–µ‚Ä¶")
        return

    # –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ—Ç–∞
    if node_id in CAT_ACTIONS:
        await message.answer(CAT_ACTIONS[node_id])
        return

    user["node"] = node_id
    node = NODES[node_id]

    if node_id == "cat_hub":
        add_item(user, "üå∏ –¶–≤–µ—Ç–æ–∫ —Ç–∏—à–∏–Ω—ã")

    await message.answer(
        node["text"],
        reply_markup=node_keyboard(node["actions"])
    )
